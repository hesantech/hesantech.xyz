<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>kubernetes Cluster Setup | Mahesan G</title>
<meta name="keywords" content="k8s" />
<meta name="description" content="Kubernetes 3 node cluster homelab setup in virtualbox">
<meta name="author" content="Mahesan G">
<link rel="canonical" href="https://hesantech.xyz/posts/2021-09/26_kubernetes_cluster_setup/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.5e2b4101351c21e906f398ae96901791830f58d430f96f2659dab7eaef7b3cb7.css" integrity="sha256-XitBATUcIekG85iulpAXkYMPWNQw&#43;W8mWdq36u97PLc=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://hesantech.xyz/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://hesantech.xyz/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://hesantech.xyz/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://hesantech.xyz/apple-touch-icon.png">
<link rel="mask-icon" href="https://hesantech.xyz/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.88.1" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="kubernetes Cluster Setup" />
<meta property="og:description" content="Kubernetes 3 node cluster homelab setup in virtualbox" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hesantech.xyz/posts/2021-09/26_kubernetes_cluster_setup/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-26T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-09-26T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="kubernetes Cluster Setup"/>
<meta name="twitter:description" content="Kubernetes 3 node cluster homelab setup in virtualbox"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://hesantech.xyz/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "kubernetes Cluster Setup",
      "item": "https://hesantech.xyz/posts/2021-09/26_kubernetes_cluster_setup/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "kubernetes Cluster Setup",
  "name": "kubernetes Cluster Setup",
  "description": "Kubernetes 3 node cluster homelab setup in virtualbox",
  "keywords": [
    "k8s"
  ],
  "articleBody": "Kubernetes is a free open source container orchestration tool. It helps to manage connectivity between containers and automatically scale up and scale down containers based on load\nEnvironment  VirtualBox Version 6.1.26 Ubuntu server 20.04 LTS Kuberentes version 1.21  Requirements  2CPU for each node 2GB Ram Disable swap 15GB HDD for each node(As per requirement) Working internet connection Unique hostname, MAC address, and product_uuid for every node. See here for more details.  I’m going to deploy this kubernets cluster with 1 master VM and 2 worker VMs, each of the VM will have 2 network adapters one with bridge network and other with virtualbox NAT network.\nBridge Network: Enables us to connect to nodes directly from home router network.\nVirtualbox NAT Network: This is a virtualbox internal NAT network all VMs within this network can communicate with each other and also communicate to internet but any machine from external network as well as physical network where host machine is connected cannot access the VMs(guest os) configured with NAT network (i.e Basically NAT Network is a virtual switch act as a gateway to internal network)\nWe can use bridge network itself but the problem with the bridge network is it always requires the home network connection and making any configuration changes to home network like switching to a different network CIDR, changes the IP of the K8s master will breaks down the entire setup. Since certificates during the K8s setup are tied to a specific IP and need to generated again each time the IP address of the master changes its a tedious task and using NAT network also enable k8s to work without any host network dependency. Hence using NAT Network.\nNetwork Setup Home Network: 192.168.0.1/24\nCreate a virtualbox NAT network 192.168.100.0/24 different than the home network address to avoid conflict with home network as shown below: Node Home Network Virtualbox Nat Network k8s-master-0 192.168.1.80 192.168.100.1 k8s-worker-1 192.168.1.90 192.168.100.2 k8s-worker-2 192.168.1.91 192.168.100.3 Steps   Download the ubuntu server 20.04 LTS for all the master and worker nodes.\n  After creating the VM with downloaded OS enable both network adapter in virtualbox as shown below\n  Begin the OS installation, with default options for language and IP with DCHP we will change this to static after setup\n  Create partitions as shown below:   Configure the profile details as shown below:   Configure the network to be static as shown below, Ubuntu server 20.04 by default uses netplan to manage network configurations in the file /etc/netplan/00-installer-config.yaml once edited as above sudo netplan apply to apply config and verifiy with ip link or ifconfig\n  Disable the swap space.\n  sudo swapon -s # check current swap status sudo swapoff -a # disable the swap sudo swapon -s # verify again Also comment the swap entry in /etc/fstab as shown below: Its good to take a snapshot now if anything goes wrong we can use this snapshot to restore current state from few clicks and also we are going to create worker VMs from this snapshot and ensure that you are creating clone with generating new mac address as shown below  Once both worker VMs create update its hostname, ip address and add host entries to /etc/hostsas shown below  We must verify that every VMs got unique MAC address ip link or ifconfig -a and product_uuid can be checked by using the command sudo cat /sys/class/dmi/id/product_uuid Lets setup containerd as CRI runtime for all nodes, execute the below commands on each nodes with root privilege for containerd prerequisites.  cat overlay br_netfilter EOF sudo modprobe overlay sudo modprobe br_netfilter # Setup required sysctl params, these persist across reboots. cat net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 EOF # Apply sysctl params without reboot sudo sysctl --system Set up the repository for containerd as mentioned below  sudo apt-get update sudo apt-get install \\  apt-transport-https \\  ca-certificates \\  curl \\  gnupg \\  lsb-release #Add Docker’s official GPG key: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg # set up the **stable** repository echo \\  \"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \\ $(lsb_release -cs)stable\" | sudo tee /etc/apt/sources.list.d/docker.list  /dev/null Install and configure containerd  #Install containerd sudo apt-get update \u0026\u0026 sudo apt-get install -y containerd #Configure sudo mkdir -p /etc/containerd containerd config default | sudo tee /etc/containerd/config.toml #Restart containerd: sudo systemctl restart containerd Once CRI runtime setup completed we can install kubernetes repo as follows to install kubernetes  #Download the Google Cloud public signing key: sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg #Add the Kubernetes `apt` repository: echo \"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main\" | sudo tee /etc/apt/sources.list.d/kubernetes.list At the time of writing this post latest kubernetes release verison is 1.22 but I’m going to install kubernetes version 1.21, So i can practice version update. If you need to install current version install without mentioning version and skip kubectl installation on worker nodes.  #Update `apt` package index, install kubelet, kubeadm and kubectl, and pin their version: sudo apt-get update sudo apt-get install -y kubelet=1.21.0-00 kubeadm=1.21.0-00 kubectl=1.21.0-00 sudo apt-mark hold kubelet kubeadm kubectl #verify the installed versions kubelet --version kubeadm version -o short kubectl version We are going to initialize cluster using kubeadm. (Execute only in master node)  #Intitate the cluster sudo kubeadm init --control-plane-endpoint k8s-master-0:6443 --pod-network-cidr 10.10.0.0/16 #In the above command POD CIDR is taken as 10.10.0.0/16, these IP address is completely internal to kubernetese so can assign any IP CIDR. #Once inilization completed we need to run the following as a regular user to start using kubectl: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Lets setup pod network (internal virtual network spans across nodes). In this setup we are going to install Calico network plugin it supports network policy and major cloud providers supports calico, You can read more about Calico and calico introduced new installation option from version 3.15 we can install calico using open source operator created by tigera i’m not used that option in this setup but you can find more details here Operator Setup By default calico uses the CIDR 192.168.0.0/16 as pod network, if you initialized the cluster with the CIDR 192.168.0.0/16 you can directly install calico with kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml. But my home network already resides on 192.168.0.0 so to avoid conflict we initialized cluster with 10.10.0.0./16 that need to be updated in calico also to do that we need to uncomment a variable CALICO_IPV4POOL_CIDR in calico installation manifest file and update the CIDR same as initialization pod network (i.e 10.10.0.0/16) as follows.  #Download the Calico networking manifest curl https://docs.projectcalico.org/manifests/calico.yaml -O #Install  kubectl apply -f calico.yaml Lets add worker nodes to the cluster. you can use initialization step16’s output which contains the command to join worker nodes to the cluster or create a new token usingkubeadm token create --print-join-command and execute the kubeadm join  command on worker nodes as root user. Once worker node joined to cluster check with kubectl get nodes and try to create a test pod kubectl run nginx --image=nginx to verify everything is working fine If anything goes wrong execute this kubeadm reset \u0026\u0026 rm -rf /etc/cni/net.d on master and worker nodes and retry all the steps.  ",
  "wordCount" : "1191",
  "inLanguage": "en",
  "datePublished": "2021-09-26T00:00:00Z",
  "dateModified": "2021-09-26T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Mahesan G"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://hesantech.xyz/posts/2021-09/26_kubernetes_cluster_setup/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Mahesan G",
    "logo": {
      "@type": "ImageObject",
      "url": "https://hesantech.xyz/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://hesantech.xyz" accesskey="h" title="Mahesan G (Alt + H)">Mahesan G</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://hesantech.xyz/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://hesantech.xyz/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://hesantech.xyz">Home</a>&nbsp;»&nbsp;<a href="https://hesantech.xyz/posts/">Posts</a></div>
    <h1 class="post-title">
      kubernetes Cluster Setup
    </h1>
    <div class="post-description">
      Kubernetes 3 node cluster homelab setup in virtualbox
    </div>
    <div class="post-meta">September 26, 2021&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Mahesan G
</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul><ul><ul>
                <li>
                    <a href="#environment" aria-label="Environment">Environment</a></li>
                <li>
                    <a href="#requirements" aria-label="Requirements">Requirements</a></li>
                <li>
                    <a href="#network-setup" aria-label="Network Setup">Network Setup</a></li></ul>
                    </ul>
                    
                <li>
                    <a href="#steps" aria-label="Steps">Steps</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><em>Kubernetes is a free open source container orchestration tool. It helps to manage  connectivity between containers and automatically scale up and scale down containers based on load</em></p>
<h4 id="environment">Environment<a hidden class="anchor" aria-hidden="true" href="#environment">#</a></h4>
<ul>
<li>VirtualBox Version 6.1.26</li>
<li>Ubuntu server 20.04 LTS</li>
<li>Kuberentes version 1.21</li>
</ul>
<h4 id="requirements">Requirements<a hidden class="anchor" aria-hidden="true" href="#requirements">#</a></h4>
<ul>
<li>2CPU for each node</li>
<li>2GB Ram</li>
<li>Disable swap</li>
<li>15GB HDD for each node(As per requirement)</li>
<li>Working internet connection</li>
<li>Unique hostname, MAC address, and product_uuid for every node. See <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#verify-mac-address">here</a> for more details.</li>
</ul>
<p>I&rsquo;m going to deploy this kubernets cluster with 1 master VM and 2 worker VMs, each of the VM will have 2 network adapters one with bridge network and other with virtualbox NAT network.</p>
<p><em><strong>Bridge  Network:</strong> Enables us to connect to nodes directly from home router network.</em></p>
<p><em><strong>Virtualbox NAT Network:</strong> This is a virtualbox internal  NAT network all VMs within this network can communicate with each other and also communicate to internet but any machine from external network as well as physical network where host machine is connected cannot access the VMs(guest os) configured with NAT network (i.e Basically NAT Network is a virtual switch act as a gateway to internal network)</em></p>
<p>We can use bridge network itself but the problem with the bridge network is  it always requires the home network connection and making any configuration changes to home network like switching to a different network CIDR, changes the IP of the K8s master will breaks down the entire setup. Since certificates during the K8s setup are tied to a specific IP and need to generated again each time the IP address of the master changes  its a tedious task and using NAT network also enable k8s to work without any host network dependency. Hence using NAT Network.</p>
<h4 id="network-setup">Network Setup<a hidden class="anchor" aria-hidden="true" href="#network-setup">#</a></h4>
<p>Home Network: 192.168.0.1/24</p>
<p>Create a virtualbox NAT network  192.168.100.0/24 different than the home network address to avoid conflict with home network as shown below:
<img loading="lazy" src="/images/26-virtualbox-natnetwork.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-md" data-lang="md">Node             Home Network        Virtualbox Nat Network
k8s-master-0       192.168.1.80        192.168.100.1
k8s-worker-1       192.168.1.90        192.168.100.2
k8s-worker-2       192.168.1.91        192.168.100.3
</code></pre></div><h2 id="steps">Steps<a hidden class="anchor" aria-hidden="true" href="#steps">#</a></h2>
<ol>
<li>
<p>Download the ubuntu server 20.04 LTS for all the master and worker nodes.</p>
</li>
<li>
<p>After creating the VM with downloaded OS enable both network adapter in virtualbox as shown below<br>
<img loading="lazy" src="/images/26-virtualbox-enablenat.png" alt=""  />
</p>
</li>
<li>
<p>Begin the OS installation, with default options for language and IP with DCHP we will change this to static after setup</p>
</li>
<li>
<p>Create partitions as shown below:
<img loading="lazy" src="/images/26-vm-partitionsetup.png" alt=""  />
</p>
</li>
<li>
<p>Configure the profile details as shown below:
<img loading="lazy" src="/images/26-vm-profile-setup.png" alt=""  />
</p>
</li>
<li>
<p>Configure the network to be static as shown below, Ubuntu server 20.04 by default uses netplan to manage network configurations in the file  <em>/etc/netplan/00-installer-config.yaml</em>
<img loading="lazy" src="/images/26-vm-config-static_ip.png" alt=""  />
</p>
<p>once edited as above <code>sudo netplan apply</code> to apply config and verifiy with <code>ip link</code> or <code>ifconfig</code></p>
</li>
<li>
<p>Disable the swap space.</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo swapon -s <span style="color:#75715e"># check current swap status</span>
sudo swapoff -a <span style="color:#75715e"># disable the swap</span>
sudo swapon -s <span style="color:#75715e"># verify again</span>
</code></pre></div><p>Also comment the swap entry in <code>/etc/fstab</code>  as shown below:
<img loading="lazy" src="/images/26-vm-swap-disable.png" alt=""  />
</p>
<ol start="8">
<li>Its good to take a snapshot now if anything goes wrong we can use this snapshot to restore current state from few clicks and also we are going to create worker VMs from this snapshot and ensure that you are creating clone with generating new mac address as shown below</li>
</ol>
<p><img loading="lazy" src="/images/26-vm-clone-settings.png" alt=""  />
</p>
<ol start="9">
<li>Once both worker VMs create update its hostname, ip address and add host entries to <code>/etc/hosts</code>as shown below</li>
</ol>
<p><img loading="lazy" src="/images/26-vm-hostentries.png" alt=""  />
</p>
<ol start="10">
<li>We must verify that every VMs got unique MAC address  <code>ip link</code> or <code>ifconfig -a</code> and product_uuid can be checked by using the command <code>sudo cat /sys/class/dmi/id/product_uuid</code></li>
<li>Lets setup containerd as CRI runtime for all nodes, execute the below commands on each nodes with root privilege for containerd prerequisites.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
</span><span style="color:#e6db74">overlay
</span><span style="color:#e6db74">br_netfilter
</span><span style="color:#e6db74">EOF</span>

sudo modprobe overlay
sudo modprobe br_netfilter

<span style="color:#75715e"># Setup required sysctl params, these persist across reboots.</span>
cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables  = 1
</span><span style="color:#e6db74">net.ipv4.ip_forward                 = 1
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span><span style="color:#e6db74">EOF</span>

<span style="color:#75715e"># Apply sysctl params without reboot</span>
sudo sysctl --system
</code></pre></div><ol start="12">
<li>Set up the repository for containerd as mentioned below</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">
 sudo apt-get update

 sudo apt-get install <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    apt-transport-https <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ca-certificates <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    gnupg <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    lsb-release
	
<span style="color:#75715e">#Add Docker’s official GPG key:</span>
 curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg 

<span style="color:#75715e"># set up the **stable** repository</span>
 echo <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#34;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
</span><span style="color:#e6db74">  </span><span style="color:#66d9ef">$(</span>lsb_release -cs<span style="color:#66d9ef">)</span><span style="color:#e6db74"> stable&#34;</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</code></pre></div><ol start="13">
<li>Install and configure containerd</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#Install containerd</span>
sudo apt-get update <span style="color:#f92672">&amp;&amp;</span> sudo apt-get install -y containerd

<span style="color:#75715e">#Configure</span>
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml

<span style="color:#75715e">#Restart containerd:</span>
sudo systemctl restart containerd
</code></pre></div><ol start="14">
<li>Once CRI runtime setup completed we can install kubernetes repo as follows to install kubernetes</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#Download the Google Cloud public signing key:</span>
sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg

<span style="color:#75715e">#Add the Kubernetes `apt` repository:</span>
echo <span style="color:#e6db74">&#34;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> | sudo tee /etc/apt/sources.list.d/kubernetes.list

</code></pre></div><ol start="15">
<li>At the time of writing this post latest kubernetes release verison is 1.22 but I&rsquo;m going to install kubernetes version 1.21, So i can practice version update. If you need to install current  version install without mentioning version and skip kubectl installation on worker nodes.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#Update `apt` package index, install kubelet, kubeadm and kubectl, and pin their version:</span>

sudo apt-get update
sudo apt-get install -y kubelet<span style="color:#f92672">=</span>1.21.0-00 kubeadm<span style="color:#f92672">=</span>1.21.0-00 kubectl<span style="color:#f92672">=</span>1.21.0-00
sudo apt-mark hold kubelet kubeadm kubectl

<span style="color:#75715e">#verify the installed versions</span>
kubelet --version
kubeadm version -o short
kubectl version
</code></pre></div><ol start="16">
<li>We are going to initialize cluster using kubeadm. <strong>(Execute only in master node)</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">
<span style="color:#75715e">#Intitate the cluster</span>
sudo kubeadm init --control-plane-endpoint k8s-master-0:6443 --pod-network-cidr 10.10.0.0/16
<span style="color:#75715e">#In the above command POD CIDR is taken as 10.10.0.0/16, these IP address is completely internal to kubernetese so can assign any IP CIDR.</span>

<span style="color:#75715e">#Once inilization completed we need to run the following as a regular user to start using kubectl:</span>
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</code></pre></div><ol start="17">
<li>Lets setup pod network (internal virtual network spans across nodes). In this setup we are going to install Calico network plugin it supports network policy and major cloud providers supports calico, You can read more about <a href="https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises#install-calico-with-kubernetes-api-datastore-50-nodes-or-less">Calico</a> and calico introduced new installation option from version 3.15  we can install calico using open source operator created by tigera i&rsquo;m not used that option in this setup but you can find more details here <a href="https://docs.projectcalico.org/getting-started/kubernetes/quickstart">Operator Setup</a>
By default calico uses the CIDR 192.168.0.0/16 as pod network, if you initialized the cluster with the CIDR 192.168.0.0/16 you can directly install calico with <code>kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</code>. But my home network already resides on 192.168.0.0 so to avoid conflict we initialized cluster with 10.10.0.0./16 that need to be updated in calico also to do that we need to uncomment a variable CALICO_IPV4POOL_CIDR in calico installation manifest  file and update the CIDR same as initialization pod network (i.e 10.10.0.0/16)  as follows.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#Download the Calico networking manifest</span>
curl https://docs.projectcalico.org/manifests/calico.yaml -O


<span style="color:#75715e">#Install </span>
kubectl apply -f calico.yaml
</code></pre></div><ol start="18">
<li>Lets add worker nodes to the cluster. you can use initialization step16&rsquo;s  output which contains the command to join worker nodes to the cluster or  create a new token using<code>kubeadm token create --print-join-command</code> and execute the <code>kubeadm join &lt;hash value&gt;</code> command on worker nodes as root user.</li>
<li>Once worker node joined to cluster check with <code>kubectl get nodes</code> and try to create a test  pod <code>kubectl run nginx --image=nginx</code> to verify everything is working fine</li>
<li>If anything goes wrong execute this <code>kubeadm reset &amp;&amp; rm -rf /etc/cni/net.d</code> on master and worker nodes and retry all the steps.</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://hesantech.xyz/tags/k8s/">k8s</a></li>
    </ul>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share kubernetes Cluster Setup on twitter"
        href="https://twitter.com/intent/tweet/?text=kubernetes%20Cluster%20Setup&amp;url=https%3a%2f%2fhesantech.xyz%2fposts%2f2021-09%2f26_kubernetes_cluster_setup%2f&amp;hashtags=k8s">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share kubernetes Cluster Setup on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fhesantech.xyz%2fposts%2f2021-09%2f26_kubernetes_cluster_setup%2f&amp;title=kubernetes%20Cluster%20Setup&amp;summary=kubernetes%20Cluster%20Setup&amp;source=https%3a%2f%2fhesantech.xyz%2fposts%2f2021-09%2f26_kubernetes_cluster_setup%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share kubernetes Cluster Setup on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fhesantech.xyz%2fposts%2f2021-09%2f26_kubernetes_cluster_setup%2f&title=kubernetes%20Cluster%20Setup">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share kubernetes Cluster Setup on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhesantech.xyz%2fposts%2f2021-09%2f26_kubernetes_cluster_setup%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share kubernetes Cluster Setup on whatsapp"
        href="https://api.whatsapp.com/send?text=kubernetes%20Cluster%20Setup%20-%20https%3a%2f%2fhesantech.xyz%2fposts%2f2021-09%2f26_kubernetes_cluster_setup%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share kubernetes Cluster Setup on telegram"
        href="https://telegram.me/share/url?text=kubernetes%20Cluster%20Setup&amp;url=https%3a%2f%2fhesantech.xyz%2fposts%2f2021-09%2f26_kubernetes_cluster_setup%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="https://hesantech.xyz">Mahesan G</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
